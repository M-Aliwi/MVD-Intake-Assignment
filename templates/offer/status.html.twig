{% extends 'base.html.twig' %}

{% block title %}Bod Status - MVD Intake{% endblock %}

{% block stylesheets %}
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .status-container {
            max-width: 800px;
            margin: 2rem auto;
            padding: 2rem;
            background: #f8f9fa;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .status-badge {
            font-size: 1.2rem;
            padding: 0.5rem 1rem;
            border-radius: 25px;
        }
        .status-pending {
            background-color: #ffc107;
            color: #000;
        }
        .status-accepted {
            background-color: #198754;
            color: #fff;
        }
        .status-rejected {
            background-color: #dc3545;
            color: #fff;
        }
        .offer-details {
            background: #fff;
            border-radius: 8px;
            padding: 1.5rem;
            margin-top: 1.5rem;
        }
        .refresh-btn {
            margin-top: 1rem;
        }
        .loading {
            display: none;
        }
    </style>
{% endblock %}

{% block body %}
<div class="container">
    <div class="status-container">
        <h1 class="text-center mb-4">Bod Status</h1>
        
        <div class="text-center mb-4">
            <span class="status-badge status-{{ offer.status }}" id="status-badge">
                {% if offer.status == 'pending' %}
                    In behandeling
                {% elseif offer.status == 'accepted' %}
                    Geaccepteerd
                {% elseif offer.status == 'rejected' %}
                    Afgewezen
                {% else %}
                    {{ offer.status|title }}
                {% endif %}
            </span>
        </div>

        <div class="offer-details">
            <h3>Uw bod details:</h3>
            <div class="row">
                <div class="col-md-6">
                    <p><strong>Naam:</strong> {{ offer.name }}</p>
                    <p><strong>E-mail:</strong> {{ offer.email }}</p>
                    <p><strong>Telefoon:</strong> {{ offer.phone }}</p>
                </div>
                <div class="col-md-6">
                    <p><strong>Bod:</strong> €{{ offer.amount|number_format(2, ',', '.') }}</p>
                    <p><strong>Geplaatst op:</strong> {{ offer.createdAt|date('d-m-Y H:i') }}</p>
                    {% if offer.externalId %}
                        <p><strong>Referentie:</strong> {{ offer.externalId }}</p>
                    {% endif %}
                </div>
            </div>
            
            {% if offer.conditions %}
                <div class="mt-3">
                    <strong>Voorwaarden:</strong>
                    <p class="mt-2">{{ offer.conditions }}</p>
                </div>
            {% endif %}
        </div>

        <div class="text-center">
            <button class="btn btn-outline-primary refresh-btn" onclick="refreshStatus()">
                <span class="spinner-border spinner-border-sm loading" role="status"></span>
                Status vernieuwen
            </button>
            <div class="mt-2">
                <small class="text-muted" id="refresh-indicator">
                    <i class="fas fa-sync-alt"></i> Automatisch vernieuwen elke 30 seconden
                </small>
            </div>
        </div>

        {% if offer.status == 'pending' %}
            <div class="alert alert-info mt-4" role="alert">
                <h5>Wat gebeurt er nu?</h5>
                <p>Uw bod wordt beoordeeld door ons team. Dit kan 2-30 minuten duren. 
                De status wordt automatisch bijgewerkt zodra er een beslissing is genomen.</p>
                <p><small>Deze pagina wordt automatisch elke 30 seconden ververst.</small></p>
            </div>
        {% elseif offer.status == 'accepted' %}
            <div class="alert alert-success mt-4" role="alert">
                <h5>Gefeliciteerd!</h5>
                <p>Uw bod is geaccepteerd. U ontvangt binnenkort een e-mail met verdere instructies.</p>
            </div>
        {% elseif offer.status == 'rejected' %}
            <div class="alert alert-danger mt-4" role="alert">
                <h5>Bod afgewezen</h5>
                <p>Helaas is uw bod afgewezen. U kunt een nieuw bod plaatsen via de hoofdpagina.</p>
                <a href="{{ path('offer_form') }}" class="btn btn-primary">Nieuw bod plaatsen</a>
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block javascripts %}
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function refreshStatus() {
            const btn = document.querySelector('.refresh-btn');
            const spinner = btn.querySelector('.spinner-border');
            const originalText = btn.innerHTML;
            
            spinner.style.display = 'inline-block';
            btn.disabled = true;
            
            fetch('{{ path('api_offer_status', {'id': offer.id}) }}')
                .then(response => response.json())
                .then(data => {
                    if (data.status !== '{{ offer.status }}') {
                        location.reload();
                    } else {
                        // Status hasn't changed, just show a brief feedback
                        btn.innerHTML = '<span class="spinner-border spinner-border-sm" style="display: none;"></span> Geüpdatet';
                        setTimeout(() => {
                            btn.innerHTML = originalText;
                            btn.disabled = false;
                        }, 1000);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    btn.innerHTML = 'Fout bij vernieuwen';
                    setTimeout(() => {
                        btn.innerHTML = originalText;
                        btn.disabled = false;
                    }, 2000);
                });
        }

        // Auto-refresh every 30 seconds
        let currentStatus = '{{ offer.status }}';
        let refreshInterval;
        let debugMode = true; // Set to false in production
        
        function startAutoRefresh() {
            if (debugMode) {
                console.log('Starting auto-refresh for offer ID: {{ offer.id }}');
                console.log('Current status:', currentStatus);
            }
            
            refreshInterval = setInterval(() => {
                if (debugMode) {
                    console.log('Auto-refreshing status...');
                }
                
                // Show refresh indicator
                const indicator = document.getElementById('refresh-indicator');
                if (indicator) {
                    indicator.innerHTML = '<i class="fas fa-sync-alt fa-spin"></i> Status controleren...';
                }
                
                fetch('{{ path('api_offer_status', {'id': offer.id}) }}')
                    .then(response => response.json())
                    .then(data => {
                        console.log('Status check result:', data);
                        if (data.status && data.status !== currentStatus) {
                            console.log('Status changed from', currentStatus, 'to', data.status);
                            location.reload();
                        } else {
                            // Reset indicator
                            if (indicator) {
                                indicator.innerHTML = '<i class="fas fa-sync-alt"></i> Automatisch vernieuwen elke 30 seconden';
                            }
                        }
                    })
                    .catch(error => {
                        console.error('Auto-refresh error:', error);
                        // Reset indicator on error
                        if (indicator) {
                            indicator.innerHTML = '<i class="fas fa-sync-alt"></i> Automatisch vernieuwen elke 30 seconden';
                        }
                    });
            }, 30000); // 30 seconds
        }
        
        // Start auto-refresh
        startAutoRefresh();
        
        // Stop auto-refresh if status is final (accepted/rejected)
        {% if offer.status == 'accepted' or offer.status == 'rejected' %}
            if (refreshInterval) {
                clearInterval(refreshInterval);
                console.log('Auto-refresh stopped - final status reached');
            }
        {% endif %}
    </script>
{% endblock %}
